<style>
  #cookie-notice {
    padding: 2rem;
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(15, 23, 42, 0.98);
    backdrop-filter: blur(20px);
    border-top: 1px solid rgba(96, 165, 250, 0.3);
    color: #cbd5e1;
    z-index: 10000;
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.3);
    border-radius: 12px 12px 0 0;
    max-height: 60vh;
    overflow-y: auto;
  }

  .cookie-header h3 {
    color: #60a5fa;
    margin: 0 0 1rem 0;
    font-size: 1.3rem;
    font-weight: 600;
  }

  .cookie-content {
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  .cookie-content p {
    margin: 0 0 1rem 0;
    font-size: 0.95rem;
  }

  .cookie-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  #cookie-notice a {
    display: inline-block;
    cursor: pointer;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    text-align: center;
    white-space: nowrap;
  }

  .btn-approve {
    background: linear-gradient(135deg, #3b82f6, #06b6d4);
    color: white;
    border: none;
  }

  .btn-approve:hover {
    background: linear-gradient(135deg, #2563eb, #0891b2);
    transform: translateY(-1px);
  }

  .btn-info {
    background: transparent;
    color: #60a5fa;
    border: 1px solid #60a5fa;
  }

  .btn-info:hover {
    background: rgba(96, 165, 250, 0.1);
    color: #93c5fd;
  }

  .btn-essential {
    background: rgba(96, 165, 250, 0.2);
    color: #60a5fa;
    border: 1px solid rgba(96, 165, 250, 0.4);
  }

  .btn-essential:hover {
    background: rgba(96, 165, 250, 0.3);
    border-color: #60a5fa;
    transform: translateY(-1px);
  }

  .btn-reject {
    background: rgba(96, 165, 250, 0.1);
    color: #60a5fa;
    border: 1px solid rgba(96, 165, 250, 0.3);
  }

  .btn-reject:hover {
    background: rgba(96, 165, 250, 0.2);
    border-color: #60a5fa;
    transform: translateY(-1px);
  }

  .btn-settings {
    background: rgba(6, 182, 212, 0.2);
    color: #06b6d4;
    border: 1px solid rgba(6, 182, 212, 0.4);
  }

  .btn-settings:hover {
    background: rgba(6, 182, 212, 0.3);
    border-color: #06b6d4;
    transform: translateY(-1px);
  }

  @media (max-width: 767px) {
    #cookie-notice {
      padding: 1rem;
      text-align: center;
    }
    .cookie-buttons {
      flex-direction: column;
    }
    #cookie-notice a {
      width: 100%;
    }
  }
</style>

<div id="cookie-notice">
  <div class="cookie-header">
    <h3>üç™ Cookie-Einstellungen</h3>
  </div>
  <div class="cookie-content">
    <p>
      Um die Informationen auf dieser Webseite und das Leistungsangebot den Bed√ºrfnissen der Nutzer
      anpassen zu k√∂nnen, setzen wir Cookies ein. Sie k√∂nnen √ºber die nachstehenden Einstellungen
      selbst entscheiden, welche Cookies bei der Nutzung der Webseite gesetzt werden sollen.
    </p>
    <p>
      <strong>Verwendete Cookies:</strong><br />
      ‚Ä¢ <strong>Technisch notwendige Cookies:</strong> Speichern Ihre Cookie-Einstellungen (Dauer:
      31 Tage)<br />
      ‚Ä¢ <strong>Google Analytics:</strong> Sammelt anonymisierte Nutzungsdaten zur
      Webseitenoptimierung (Dauer: 26 Monate)
    </p>
  </div>
  <div class="cookie-buttons">
    <a id="cookie-notice-accept" class="btn-approve">Alle akzeptieren</a>
    <a id="cookie-notice-essential" class="btn-essential">Nur notwendige</a>
    <a id="cookie-notice-reject" class="btn-reject">Alle ablehnen</a>
    <a id="cookie-settings-btn" class="btn-settings">Cookie-Einstellungen</a>
    <a href="/datenschutz" class="btn-info">Datenschutzerkl√§rung</a>
  </div>
</div>

<!-- Widerrufs-Button und Theme Toggle (immer sichtbar am unteren Rand) -->
<div
  id="cookie-revoke"
  style="
    position: fixed;
    bottom: 10px;
    right: 10px;
    z-index: 9999;
    display: flex;
    gap: 0.5rem;
    align-items: center;
  "
>
  <!-- Theme Toggle Button -->
  <div
    style="
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 8px;
      padding: 0.3rem 0.5rem;
      backdrop-filter: blur(10px);
    "
  >
    <button
      class="theme-toggle-cookie"
      type="button"
      aria-label="Zu hellem Modus wechseln"
      style="
        background: none;
        border: none;
        color: #60a5fa;
        font-size: 0.9rem;
        cursor: pointer;
        padding: 0;
        transition: all 0.3s ease;
        min-width: 20px;
      "
    >
      <span class="theme-icon-cookie">‚òÄÔ∏è</span>
    </button>
  </div>

  <!-- Cookie Settings Button -->
  <div
    style="
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      backdrop-filter: blur(10px);
    "
  >
    <a
      href="#"
      id="revoke-consent"
      style="color: #60a5fa; text-decoration: none; font-size: 0.8rem; font-weight: 500"
      >Cookie-Einstellungen √§ndern</a
    >
  </div>
</div>

<!-- Detaillierte Cookie-Einstellungen Modal -->
<div
  id="cookie-settings-modal"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 10001;
    backdrop-filter: blur(5px);
  "
>
  <div
    style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #0f172a;
      border: 1px solid rgba(96, 165, 250, 0.3);
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      color: #cbd5e1;
    "
  >
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      "
    >
      <h2 style="color: #60a5fa; margin: 0">Cookie-Einstellungen</h2>
      <button
        id="close-settings"
        style="background: none; border: none; color: #60a5fa; font-size: 1.5rem; cursor: pointer"
      >
        &times;
      </button>
    </div>

    <div class="cookie-category">
      <h3 style="color: #60a5fa; margin-bottom: 1rem">Technisch notwendige Cookies</h3>
      <div
        style="
          background: rgba(96, 165, 250, 0.1);
          border-left: 3px solid #60a5fa;
          padding: 1rem;
          margin-bottom: 1.5rem;
          border-radius: 0 8px 8px 0;
        "
      >
        <p><strong>Zweck:</strong> Speicherung Ihrer Cookie-Einstellungen und Einwilligungen</p>
        <p><strong>Dauer:</strong> 31 Tage</p>
        <p><strong>Anbieter:</strong> Diese Website (Erstanbieter)</p>
        <p><strong>Daten:</strong> Cookie-Einwilligung, Zeitstempel, Browser-Information</p>
        <p style="margin-bottom: 0">
          <strong>Rechtsgrundlage:</strong> Berechtigtes Interesse (Art. 6 Abs. 1 lit. f DSGVO)
        </p>
        <label
          style="
            display: flex;
            align-items: center;
            margin-top: 1rem;
            cursor: not-allowed;
            opacity: 0.7;
          "
        >
          <input type="checkbox" checked disabled style="margin-right: 0.5rem" />
          Immer aktiv (technisch erforderlich)
        </label>
      </div>
    </div>

    <div class="cookie-category">
      <h3 style="color: #60a5fa; margin-bottom: 1rem">Google Analytics</h3>
      <div
        style="
          background: rgba(255, 193, 7, 0.1);
          border-left: 3px solid #ffc107;
          padding: 1rem;
          margin-bottom: 1.5rem;
          border-radius: 0 8px 8px 0;
        "
      >
        <p><strong>Zweck:</strong> Analyse des Nutzerverhaltens zur Webseitenoptimierung</p>
        <p><strong>Dauer:</strong> 26 Monate (_ga), 24 Stunden (_gid)</p>
        <p><strong>Anbieter:</strong> Google LLC, USA</p>
        <p>
          <strong>Daten:</strong> Anonymisierte IP-Adresse, Browser-Typ, Besuchszeiten, besuchte
          Seiten
        </p>
        <p><strong>Rechtsgrundlage:</strong> Einwilligung (Art. 6 Abs. 1 lit. a DSGVO)</p>
        <p style="margin-bottom: 0">
          <strong>Datenschutz:</strong> IP-Anonymisierung aktiviert, keine Personalisierung
        </p>
        <label style="display: flex; align-items: center; margin-top: 1rem; cursor: pointer">
          <input type="checkbox" id="analytics-consent" style="margin-right: 0.5rem" />
          Google Analytics zulassen
        </label>
      </div>
    </div>

    <div
      style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; flex-wrap: wrap"
    >
      <a id="save-settings" class="btn-settings" style="text-decoration: none"
        >Einstellungen speichern</a
      >
      <a id="accept-all-settings" class="btn-approve" style="text-decoration: none"
        >Alle akzeptieren</a
      >
    </div>
  </div>
</div>

<script>
  function createCookie(name, value, days) {
    var expires = '';
    if (days) {
      var date = new Date();
      date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
      expires = '; expires=' + date.toUTCString();
    }
    document.cookie = name + '=' + value + expires + '; path=/';
  }

  // DSGVO-konforme Zustimmungsdokumentation
  function logConsent(choice) {
    const consentRecord = {
      choice: choice,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent,
      ipHash: 'client-side', // IP wird serverseitig gehashed
      version: '1.0',
    };
    localStorage.setItem('dsgvo-consent-record', JSON.stringify(consentRecord));
    console.log('DSGVO Zustimmung dokumentiert:', consentRecord);
  }

  function readCookie(name) {
    var nameEQ = name + '=';
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) == ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }

  function eraseCookie(name) {
    createCookie(name, '', -1);
  }

  // Check if consent was given and show banner if not
  function checkCookieConsent() {
    const consentCookie = readCookie('cookie-notice-dismissed');
    console.log('Cookie consent status:', consentCookie);

    const banner = document.getElementById('cookie-notice');
    const revokeButton = document.getElementById('cookie-revoke');

    if (
      !consentCookie ||
      (consentCookie !== 'accept' && consentCookie !== 'essential' && consentCookie !== 'reject')
    ) {
      console.log('No consent - showing banner');
      if (banner) {
        banner.style.display = 'block';
        console.log('Cookie banner displayed');
      }
      if (revokeButton) {
        revokeButton.style.display = 'none';
      }
    } else {
      console.log('Consent already given:', consentCookie);
      if (banner) {
        banner.style.display = 'none';
      }
      if (revokeButton) {
        revokeButton.style.display = 'block';
      }

      // Handle consent-based loading
      if (consentCookie === 'accept' || consentCookie === 'essential') {
        // Load Cloudflare Turnstile for bot protection
        loadCloudflare();
      } else if (consentCookie === 'reject') {
        // Block website if essential cookies are rejected
        blockWebsite();
      }
    }
  }

  // Wait for DOM to be ready
  document.addEventListener('DOMContentLoaded', function () {
    checkCookieConsent();

    // Add event listeners for all three options
    const acceptButton = document.getElementById('cookie-notice-accept');
    const essentialButton = document.getElementById('cookie-notice-essential');
    const rejectButton = document.getElementById('cookie-notice-reject');
    const settingsButton = document.getElementById('cookie-settings-btn');

    if (acceptButton) {
      acceptButton.addEventListener('click', function () {
        console.log('Accept all cookies button clicked');
        createCookie('cookie-notice-dismissed', 'accept', 31);
        logConsent('accept'); // DSGVO Dokumentation
        document.getElementById('cookie-notice').style.display = 'none';
        document.getElementById('cookie-revoke').style.display = 'block';
        // Load Cloudflare Turnstile for bot protection
        loadCloudflare();
        location.reload();
      });
    }

    if (essentialButton) {
      essentialButton.addEventListener('click', function () {
        console.log('Essential only cookies button clicked');
        createCookie('cookie-notice-dismissed', 'essential', 31);
        logConsent('essential'); // DSGVO Dokumentation
        document.getElementById('cookie-notice').style.display = 'none';
        document.getElementById('cookie-revoke').style.display = 'block';
        // Load Cloudflare Turnstile for bot protection (essential)
        loadCloudflare();
      });
    }

    if (rejectButton) {
      rejectButton.addEventListener('click', function () {
        console.log('Reject all cookies button clicked');
        createCookie('cookie-notice-dismissed', 'reject', 31);
        logConsent('reject'); // DSGVO Dokumentation
        document.getElementById('cookie-notice').style.display = 'none';
        // Clear any existing analytics cookies
        clearAnalyticsCookies();
        // Block website since essential cookies are rejected
        blockWebsite();
      });
    }

    // Widerrufs-Button Event Listener
    const revokeButton = document.getElementById('revoke-consent');
    if (revokeButton) {
      revokeButton.addEventListener('click', function (e) {
        e.preventDefault();
        console.log('Cookie consent revoked by user');
        // L√∂sche bestehende Zustimmung
        eraseCookie('cookie-notice-dismissed');
        localStorage.removeItem('dsgvo-consent-record');
        // L√∂sche Analytics Cookies
        clearAnalyticsCookies();
        // Zeige Banner erneut
        document.getElementById('cookie-notice').style.display = 'block';
        // Verstecke Widerrufs-Button tempor√§r
        document.getElementById('cookie-revoke').style.display = 'none';
      });
    }

    // Settings Modal Event Listeners
    if (settingsButton) {
      settingsButton.addEventListener('click', function (e) {
        e.preventDefault();
        openSettingsModal();
      });
    }

    document.getElementById('close-settings')?.addEventListener('click', closeSettingsModal);
    document.getElementById('save-settings')?.addEventListener('click', saveSettingsFromModal);
    document.getElementById('accept-all-settings')?.addEventListener('click', acceptAllFromModal);

    // Close modal on background click
    document.getElementById('cookie-settings-modal')?.addEventListener('click', function (e) {
      if (e.target.id === 'cookie-settings-modal') {
        closeSettingsModal();
      }
    });
  });

  // Settings Modal Functions
  function openSettingsModal() {
    const modal = document.getElementById('cookie-settings-modal');
    const currentChoice = readCookie('cookie-notice-dismissed');

    // Set current analytics preference
    const analyticsCheckbox = document.getElementById('analytics-consent');
    if (analyticsCheckbox) {
      analyticsCheckbox.checked = currentChoice === 'accept';
    }

    modal.style.display = 'block';
  }

  function closeSettingsModal() {
    document.getElementById('cookie-settings-modal').style.display = 'none';
  }

  function saveSettingsFromModal() {
    const analyticsConsent = document.getElementById('analytics-consent').checked;
    const choice = analyticsConsent ? 'accept' : 'essential';

    createCookie('cookie-notice-dismissed', choice, 31);
    logConsent(choice);

    if (!analyticsConsent) {
      clearAnalyticsCookies();
    }

    closeSettingsModal();
    document.getElementById('cookie-notice').style.display = 'none';
    document.getElementById('cookie-revoke').style.display = 'block';

    if (analyticsConsent) {
      location.reload();
    }
  }

  function acceptAllFromModal() {
    createCookie('cookie-notice-dismissed', 'accept', 31);
    logConsent('accept');
    closeSettingsModal();
    document.getElementById('cookie-notice').style.display = 'none';
    document.getElementById('cookie-revoke').style.display = 'block';
    location.reload();
  }

  // Function to clear Google Analytics cookies
  function clearAnalyticsCookies() {
    const cookies = document.cookie.split(';');
    cookies.forEach(cookie => {
      const eqPos = cookie.indexOf('=');
      const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();

      if (name.startsWith('_ga') || name.startsWith('_gid')) {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.${window.location.hostname}`;
      }
    });
  }

  // Cloudflare Turnstile Management
  let turnstileLoaded = false;

  function loadCloudflare() {
    if (turnstileLoaded) return;

    // Load Turnstile API
    const script = document.createElement('script');
    script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js';
    script.defer = true;
    script.onload = function () {
      console.log('üõ°Ô∏è Cloudflare Turnstile loaded');
      initializeTurnstileWidgets();
    };
    document.head.appendChild(script);
    turnstileLoaded = true;
  }

  function initializeTurnstileWidgets() {
    // Show all turnstile protection divs and hide content
    const protectionDivs = document.querySelectorAll('[id$="-turnstile-protection"]');
    protectionDivs.forEach(div => {
      if (div) {
        div.style.display = 'flex';
        console.log('Showing Turnstile protection:', div.id);
      }
    });

    // Hide all content divs initially
    const contentDivs = document.querySelectorAll('[id$="-content"]');
    contentDivs.forEach(div => {
      if (div) {
        div.style.display = 'none';
        console.log('Hiding content until verification:', div.id);
      }
    });
  }

  function blockWebsite() {
    // Hide all content
    const contentDivs = document.querySelectorAll('[id$="-content"]');
    contentDivs.forEach(div => {
      if (div) {
        div.style.display = 'none';
      }
    });

    // Show blocking message
    const blockingDiv = document.createElement('div');
    blockingDiv.id = 'website-blocked';
    blockingDiv.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      z-index: 20000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #cbd5e1;
      padding: 2rem;
    `;
    blockingDiv.innerHTML = `
      <div style="max-width: 500px;">
        <h2 style="color: #ef4444; margin-bottom: 1.5rem;">‚ö†Ô∏è Technische Cookies erforderlich</h2>
        <p style="margin-bottom: 2rem; line-height: 1.6;">
          Diese Website ben√∂tigt technisch notwendige Cookies f√ºr den Bot-Schutz durch Cloudflare Turnstile. 
          Ohne diese Cookies kann die Website nicht sicher bereitgestellt werden.
        </p>
        <p style="margin-bottom: 2rem;">
          Bitte akzeptieren Sie die notwendigen Cookies, um fortzufahren.
        </p>
        <button onclick="showCookieSettings()" style="
          background: linear-gradient(135deg, #3b82f6, #06b6d4);
          color: white;
          border: none;
          padding: 1rem 2rem;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          font-size: 1rem;
        ">Cookie-Einstellungen anzeigen</button>
      </div>
    `;

    if (!document.getElementById('website-blocked')) {
      document.body.appendChild(blockingDiv);
    }
  }

  // Function to show cookie settings from blocked state
  function showCookieSettings() {
    // Remove blocking overlay
    const blockingDiv = document.getElementById('website-blocked');
    if (blockingDiv) {
      blockingDiv.remove();
    }

    // Show cookie banner again
    const banner = document.getElementById('cookie-notice');
    if (banner) {
      banner.style.display = 'block';
    }

    // Hide revoke button
    const revokeButton = document.getElementById('cookie-revoke');
    if (revokeButton) {
      revokeButton.style.display = 'none';
    }
  }

  // Theme Toggle functionality for cookie area
  document.addEventListener('DOMContentLoaded', function () {
    const cookieThemeToggle = document.querySelector('.theme-toggle-cookie');
    const body = document.body;

    // Sync with main theme toggle on page load
    function syncCookieThemeToggle() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      const themeIconCookie = document.querySelector('.theme-icon-cookie');

      if (savedTheme === 'light') {
        body.setAttribute('data-theme', 'light');
        if (themeIconCookie) {
          themeIconCookie.textContent = 'üåô';
          cookieThemeToggle.setAttribute('aria-label', 'Zu dunklem Modus wechseln');
        }
      } else {
        body.removeAttribute('data-theme');
        if (themeIconCookie) {
          themeIconCookie.textContent = '‚òÄÔ∏è';
          cookieThemeToggle.setAttribute('aria-label', 'Zu hellem Modus wechseln');
        }
      }
    }

    // Initial sync
    syncCookieThemeToggle();

    // Cookie theme toggle event listener
    if (cookieThemeToggle) {
      cookieThemeToggle.addEventListener('click', () => {
        const currentTheme = body.getAttribute('data-theme');
        const themeIconCookie = cookieThemeToggle.querySelector('.theme-icon-cookie');

        if (currentTheme === 'light') {
          // Switch to dark mode
          body.removeAttribute('data-theme');
          themeIconCookie.textContent = '‚òÄÔ∏è';
          cookieThemeToggle.setAttribute('aria-label', 'Zu hellem Modus wechseln');
          localStorage.setItem('theme', 'dark');
        } else {
          // Switch to light mode
          body.setAttribute('data-theme', 'light');
          themeIconCookie.textContent = 'üåô';
          cookieThemeToggle.setAttribute('aria-label', 'Zu dunklem Modus wechseln');
          localStorage.setItem('theme', 'light');
        }
      });
    }
  });
</script>
