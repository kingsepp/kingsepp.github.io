#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# 1. Lint JavaScript
echo "ğŸ“ Linting JavaScript..."
npx eslint assets/js/cookie-consent.js || {
    echo "âŒ JavaScript Linting failed"
    exit 1
}

# 2. Unit Tests
echo "ğŸ§ª Running Unit Tests..."
npm test -- --watchAll=false --silent || {
    echo "âŒ Unit Tests failed"
    exit 1
}

# 3. Cookie Consent Validation
echo "ğŸª Validating Cookie Consent Implementation..."

# PrÃ¼fe ob GA conditional geladen wird
if ! grep -q "loadGoogleAnalytics" assets/js/cookie-consent.js; then
    echo "âŒ Google Analytics conditional loading nicht gefunden"
    exit 1
fi

# PrÃ¼fe ob Opt-Out vorhanden ist
if ! grep -q "revokeConsent\|deleteGoogleAnalyticsCookies" assets/js/cookie-consent.js; then
    echo "âŒ Cookie Opt-Out Mechanismus fehlt"
    exit 1
fi

# PrÃ¼fe DatenschutzerklÃ¤rung
PRIVACY_KEYWORDS=("Google Analytics" "Cookie-Banner" "Opt-Out" "DSGVO")
for keyword in "${PRIVACY_KEYWORDS[@]}"; do
    if ! grep -q "$keyword" datenschutz.md; then
        echo "âŒ '$keyword' fehlt in DatenschutzerklÃ¤rung"
        exit 1
    fi
done

# 4. Performance Check
echo "âš¡ Checking Performance..."
JS_SIZE=$(stat -c%s "assets/js/cookie-consent.js" 2>/dev/null || stat -f%z "assets/js/cookie-consent.js")
if [ $JS_SIZE -gt 100000 ]; then
    echo "âš ï¸ Cookie-Consent.js ist sehr groÃŸ: ${JS_SIZE} bytes"
    echo "ğŸ’¡ Ãœberdenke Code-Optimierung"
fi

echo "âœ… All pre-commit checks passed!"
echo "ğŸš€ Ready to commit"